<!--index.html-->
<title>Avoids.io</title>

<body bgcolor="#CAC9C9">
	<style>
		.float_center {
		  float: right;

		  position: relative;
		  left: -50%;
		  text-align: left;
		}
		.float_center > .child {
		  position: relative;
		  left: 50%;
		}
	</style>

	<div class="float_center">
		<ul class="child">
			<div id="promptDiv" style="display:inline-block;">
				Name: <input id="promptDiv-name" type="text"></input>
				<button id="promptDiv-play">PLAY!</button>
			</div>
			<div id="gameDiv" style="display:none;">
				<canvas id="ctx" width="1600px" height="760px" style="border:1px solid #000000; background-color: #3A3A38; "></canvas>
				<div id="chat-text" style="width:1600px;height:140px;overflow-y:scroll; background-color: #85C1E9; ">
				    <div>Welcome to chat!</div>
				</div>
				 
				<form id="chat-form">
				    <input id="chat-input" type="text" style="width:1600px"></input>
				</form>
			</div>
		</ul>
	</div>
	 
	<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
	<script>
		//Set Up
		var chatText = document.getElementById('chat-text');
	    var chatInput = document.getElementById('chat-input');
	    var chatForm = document.getElementById('chat-form');
	    var ctx = document.getElementById("ctx").getContext("2d");
	    ctx.font = '30px Arial';

	    var socket = io();

	    var WIDTH = 1600;
	    var HEIGHT = 760;


	    function getRandomColor() {
		  var letters = '0123456789ABCDEF';
		  var color = '#';
		  for (var i = 0; i < 6; i++) {
		    color += letters[Math.floor(Math.random() * 16)];
		  }
		  return color;
		}

		function updateScroll(){
		    chatText.scrollTop = chatText.scrollHeight;
		}

		setInterval(updateScroll,1000/25);

	    
	    //username setup
	    var promptDiv = document.getElementById('promptDiv')
	    var promptDivname = document.getElementById('promptDiv-name')
	    var promptDivplay = document.getElementById('promptDiv-play')

	    promptDivplay.onclick = function(){
	    	var randcolor = getRandomColor();
	    	socket.emit('play',{
	    		name:promptDivname.value,
	    		color:randcolor,
	    	});	
	    	promptDiv.style.display = 'none';
	    	gameDiv.style.display = 'inline-block';
	    }

	    socket.on('addToChat',function(data){
	        chatText.innerHTML += '<div>' + data + '</div>';
	    });
	    socket.on('evalAnswer',function(data){
	        console.log(data);
	    });
	   
	    chatForm.onsubmit = function(e){
	        e.preventDefault();
	        if(chatInput.value[0] === '/')
	            socket.emit('evalServer',chatInput.value.slice(1));
	        else
	            socket.emit('sendMsgToServer',{
	            	value:chatInput.value,
	            	name:promptDivname.value,
	            });
	        chatInput.value = '';      
	    }

	    //game
	    var Img = {};
	    Img.map1['lvl1'] = new Image();
	    Img.map1['lvl1'].src = '/client/maps/avoids_map_lvl1.png';


	    var Player = function(initPack){
			var self = {};
			self.id = initPack.id;
			self.username = initPack.name;
			self.color = initPack.color;
			self.x = initPack.x;
			self.y = initPack.y;
			
			self.draw = function(){	
				var x = self.x - Player.list[selfId].x + WIDTH/2;
				var y = self.y - Player.list[selfId].y + HEIGHT/2;

				ctx.fillStyle = self.color;
				ctx.beginPath();
				ctx.arc(x,y,20,0,2*Math.PI)
				ctx.fill();

				/*ctx.font = '16px Arial';
				ctx.fillStyle = 'black';
				ctx.fillText(,x,y+50)
				ctx.font = '30px Arial';*/
			},
			
			Player.list[self.id] = self;
			
			
			return self;
		}
		Player.list = {};

		var selfId = null;
	 	
		socket.on('init',function(data){	
			if(data.selfId)
				selfId = data.selfId;
			for(var i = 0 ; i < data.player.length; i++){
				new Player(data.player[i]);
			}
		});

		socket.on('update',function(data){
			for(var i = 0 ; i < data.player.length; i++){
				var pack = data.player[i];
				var p = Player.list[pack.id];
				if(p){
					if(pack.x !== undefined)
						p.x = pack.x;
					if(pack.y !== undefined)
						p.y = pack.y;
				}
			}
		});

		socket.on('remove',function(data){
			for(var i = 0 ; i < data.player.length; i++){
				delete Player.list[data.player[i]];
			}
		});
		
		setInterval(function(){
			if(!selfId)
				return;
			ctx.clearRect(0,0,WIDTH,HEIGHT);
			drawMap();
			for(var i in Player.list)
				Player.list[i].draw();
		},40);

		var drawMap = function(){
			var x = WIDTH/2 - Player.list[selfId].x;
			var y = HEIGHT/2 - Player.list[selfId].y;
			ctx.drawImage(Img.maplvl1,x,y);
			/*var maplvl1 = [
				[4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],
				[4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4],
				[4, 4, ]
			];
		}*/

	    document.onkeydown = function(event){
	        if(event.keyCode === 68)    //d
	            socket.emit('keyPress',{inputId:'right',state:true});
	        else if(event.keyCode === 83)   //s
	            socket.emit('keyPress',{inputId:'down',state:true});
	        else if(event.keyCode === 65) //a
	            socket.emit('keyPress',{inputId:'left',state:true});
	        else if(event.keyCode === 87) // w
	            socket.emit('keyPress',{inputId:'up',state:true});
	           
	    }
	    document.onkeyup = function(event){
	        if(event.keyCode === 68)    //d
	            socket.emit('keyPress',{inputId:'right',state:false});
	        else if(event.keyCode === 83)   //s
	            socket.emit('keyPress',{inputId:'down',state:false});
	        else if(event.keyCode === 65) //a
	            socket.emit('keyPress',{inputId:'left',state:false});
	        else if(event.keyCode === 87) // w
	            socket.emit('keyPress',{inputId:'up',state:false});
	    }
	   
	</script>
</body>